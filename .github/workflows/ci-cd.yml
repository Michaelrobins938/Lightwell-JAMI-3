name: Luna CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run OWASP ZAP security scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: Run dependency vulnerability scan
        run: |
          npm audit --audit-level=high
          npm audit fix --dry-run

      - name: Upload security scan results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            snyk-report.json
            zap-report.html
            npm-audit.json

  # Code Quality & Testing
  quality-test:
    name: Quality & Testing
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type checking
        run: npm run type-check

      - name: Run unit tests
        run: npm run test:unit -- --coverage

      - name: Run integration tests
        run: npm run test:integration

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Run accessibility tests
        run: npm run test:a11y

      - name: Run performance tests
        run: npm run test:performance

      - name: Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            coverage/
            test-results/
            lighthouse-report.json

  # Build & Package
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: quality-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup environment variables
        run: |
          cp .env.example .env.local
          echo "NODE_ENV=production" >> .env.local
          echo "NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}" >> .env.local

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build application
        run: npm run build

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            package.json
            package-lock.json

  # Docker Image Build
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Staging Deployment
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: docker-build
    environment: staging
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging environment
        run: |
          echo "Deploying to staging environment..."
          # Add your staging deployment logic here
          # Example: kubectl apply -f k8s/staging/
          # Example: docker-compose -f docker-compose.staging.yml up -d

      - name: Run health checks
        run: |
          echo "Running health checks..."
          # Add health check logic here
          # Example: curl -f http://staging.luna-app.com/api/health

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test logic here

      - name: Notify staging deployment
        run: |
          echo "Staging deployment completed successfully"
          # Add notification logic here (Slack, email, etc.)

  # Production Deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker-build, deploy-staging]
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production environment
        run: |
          echo "Deploying to production environment..."
          # Add your production deployment logic here
          # Example: kubectl apply -f k8s/production/
          # Example: docker-compose -f docker-compose.prod.yml up -d

      - name: Run production health checks
        run: |
          echo "Running production health checks..."
          # Add production health check logic here
          # Example: curl -f https://luna-app.com/api/health

      - name: Run production smoke tests
        run: |
          echo "Running production smoke tests..."
          # Add production smoke test logic here

      - name: Setup monitoring
        run: |
          echo "Setting up production monitoring..."
          # Add monitoring setup logic here
          # Example: Setup Prometheus, Grafana, etc.

      - name: Notify production deployment
        run: |
          echo "Production deployment completed successfully"
          # Add notification logic here (Slack, email, etc.)

  # Documentation Update
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate API documentation
        run: |
          npm run docs:generate
          # Generate OpenAPI specs, etc.

      - name: Update deployment documentation
        run: |
          echo "Updating deployment documentation..."
          # Update deployment guides, etc.

      - name: Commit documentation updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          git commit -m "Update documentation [skip ci]" || echo "No changes to commit"
          git push

  # Performance Monitoring
  performance-monitor:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        run: |
          npm run test:performance
          # Run Lighthouse CI, WebPageTest, etc.

      - name: Upload performance results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: |
            lighthouse-results/
            webpagetest-results/
            performance-report.json

  # Security Compliance
  security-compliance:
    name: Security Compliance
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run HIPAA compliance check
        run: |
          echo "Running HIPAA compliance check..."
          # Add HIPAA compliance validation

      - name: Run GDPR compliance check
        run: |
          echo "Running GDPR compliance check..."
          # Add GDPR compliance validation

      - name: Run accessibility compliance check
        run: |
          echo "Running accessibility compliance check..."
          # Add WCAG 2.2 AA compliance validation

      - name: Upload compliance results
        uses: actions/upload-artifact@v3
        with:
          name: compliance-results
          path: |
            hipaa-report.json
            gdpr-report.json
            accessibility-report.json

  # Crisis Intervention Validation
  crisis-validation:
    name: Crisis Intervention Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run crisis intervention tests
        run: |
          echo "Running crisis intervention validation..."
          npm run test:crisis
          # Test crisis keyword detection, emergency protocols, etc.

      - name: Validate crisis response times
        run: |
          echo "Validating crisis response times..."
          # Ensure crisis intervention responds within 200ms

      - name: Upload crisis validation results
        uses: actions/upload-artifact@v3
        with:
          name: crisis-validation-results
          path: |
            crisis-test-results/
            response-time-report.json

  # Final Validation
  final-validation:
    name: Final Validation
    runs-on: ubuntu-latest
    needs: [performance-monitor, security-compliance, crisis-validation]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run comprehensive validation
        run: |
          echo "Running comprehensive validation..."
          # Final validation of all systems

      - name: Generate deployment report
        run: |
          echo "Generating deployment report..."
          # Generate comprehensive deployment report

      - name: Upload final validation results
        uses: actions/upload-artifact@v3
        with:
          name: final-validation-results
          path: |
            deployment-report.json
            validation-summary.json

      - name: Notify completion
        run: |
          echo "Luna platform deployment completed successfully!"
          # Send final notification 